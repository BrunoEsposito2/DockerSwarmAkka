name: Generate API Documentation

on:
  workflow_run:
    workflows: ["Semantic Release Workflow"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-api-docs:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Pages
      uses: actions/configure-pages@v3
        
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'corretto'
        java-version: '17'

    - name: Get version info
      id: version
      run: |
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
        VERSION=${LATEST_TAG#v}
        MAJOR_VERSION=$(echo $VERSION | cut -d. -f1)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "major_version=$MAJOR_VERSION" >> $GITHUB_OUTPUT
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "Generated for version: $VERSION (major: $MAJOR_VERSION)"
        
    - name: Set execute permissions for gradlew
      run: chmod +x ./gradlew

    # Pulisci e crea la struttura per GitHub Pages
    - name: Setup GitHub Pages structure
      run: |
        # Rimuovi la cartella docs esistente che contiene il tema
        rm -rf docs
        
        # Crea la nuova struttura per GitHub Pages
        mkdir -p _site/api/v${{ steps.version.outputs.major_version }}/scala
        mkdir -p _site/api/v${{ steps.version.outputs.major_version }}/docker
        
        # Copia il file _config.yml se esiste nella root
        if [ -f "_config.yml" ]; then
          cp _config.yml _site/
        fi

    - name: Generate Scaladoc for both nodes
      run: |
        echo "Generating Scaladoc for Public API..."
        
        ./gradlew scaladoc -PincludePackages="org.example.api"
        
        # Copy Scaladoc output (use node1 as both should be identical for API)
        if [ -d "node1/build/docs/scaladoc" ]; then
          cp -r node1/build/docs/scaladoc/* _site/api/v${{ steps.version.outputs.major_version }}/scala/
        else
          echo "Warning: Scaladoc not generated, creating placeholder"
          echo "<html><body><h1>Scala API Documentation</h1><p>Version ${{ steps.version.outputs.version }}</p></body></html>" > _site/api/v${{ steps.version.outputs.major_version }}/scala/index.html
        fi
        
    - name: Extract Docker Compose Public API
      run: |
        # Install yq for YAML parsing
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
        
        cat > _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md << EOF
        ---
        layout: default
        title: Docker Compose Public API v${{ steps.version.outputs.major_version }}
        ---
        
        # Docker Compose Public API v${{ steps.version.outputs.major_version }}
        
        **Version:** ${{ steps.version.outputs.version }}  
        **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ## API Overview
        
        EOF
        
        # Extract public API header comments
        sed -n '/^# Public API:/,/^$/p' docker-compose.yml | sed 's/^# *//' | sed 's/^#$//' >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
        
        echo "" >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
        echo "## Public Services" >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
        echo "" >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
        
        # Extract services
        yq eval '.services | keys | .[]' docker-compose.yml | while read -r service; do
          echo "### $service" >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
          echo "" >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
          echo '```yaml' >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
          yq eval ".services.${service}" docker-compose.yml >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
          echo '```' >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
          echo "" >> _site/api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.md
        done

    - name: Create Docker API index
      run: |
        cat > _site/api/v${{ steps.version.outputs.major_version }}/docker/index.md << EOF
        ---
        layout: default
        title: Docker Compose API v${{ steps.version.outputs.major_version }}
        ---
        
        # Docker Compose API v${{ steps.version.outputs.major_version }}
        
        ## Deployment Configuration
        [View detailed configuration](./deployment-api.html)
        EOF

    - name: Generate Version-specific Index
      run: |
        cat > _site/api/v${{ steps.version.outputs.major_version }}/index.md << EOF
        ---
        layout: default
        title: Public API Documentation v${{ steps.version.outputs.major_version }}
        ---
        
        # Public API Documentation v${{ steps.version.outputs.major_version }}
        
        **Current Version:** ${{ steps.version.outputs.version }}  
        **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ## 📨 Message Protocol API
        
        - [Scala API Documentation](./scala/) - Actor message protocols and service keys
        
        ## 🐳 Deployment API
        
        - [Docker Compose Interface](./docker/) - Service configuration and networking
        
        ## 🔄 Version History
        
        - [All API Versions](../index.html) - Browse historical API documentation
        - [Migration Guide](https://github.com/brunoesposito2/DockerSwarmAkka/releases) - Breaking changes between versions
        
        ## 📋 Semantic Versioning
        
        This API follows [Semantic Versioning 2.0.0](https://semver.org/):
        
        | Version Component | When to Increment | Examples |
        |------------------|-------------------|----------|
        | **MAJOR** (breaking) | Incompatible changes | Message protocol changes, port changes, service renames |
        | **MINOR** (feature) | Backward compatible features | New message types, optional configurations |
        | **PATCH** (fix) | Backward compatible fixes | Bug fixes, documentation updates |
        
        ## 🚀 Quick Start
        
        ### Using the Message Protocol
        
        \`\`\`scala
        import org.example.api.protocol.{Ping, Pong}
        import org.example.api.discovery.ServiceKeys
        
        // Register service
        context.system.receptionist ! Receptionist.Register(ServiceKeys.PingServiceKey, context.self)
        
        // Send message
        pingService ! Ping(context.self)
        \`\`\`
        
        ### Deploying with Docker Compose
        
        \`\`\`bash
        # Set required environment variables
        export JOIN_TOKEN=\$(docker swarm join-token -q worker)
        export MANAGER_IP=\$(docker node inspect self --format '{{.Status.Addr}}')
        
        # Deploy the cluster
        docker-compose up -d
        \`\`\`
        EOF

    - name: Create Scala API index
      run: |
        cat > _site/api/v${{ steps.version.outputs.major_version }}/scala/index.md << EOF
        ---
        layout: default
        title: Scala API Documentation v${{ steps.version.outputs.major_version }}
        ---
        
        # Scala API Documentation v${{ steps.version.outputs.major_version }}
        
        **Version:** ${{ steps.version.outputs.version }}
        
        ## Generated Documentation
        
        - [Browse Scaladoc](../index.html) - Complete API reference
        
        ## Key Components
        
        - **Message Protocol**: Ping/Pong actor messages
        - **Service Discovery**: ServiceKeys for actor registration
        - **Public Packages**: org.example.api.*
        EOF

    - name: Update Main API Index
      run: |
        # Create main index with all versions
        ls _site/api/ 2>/dev/null | grep "^v[0-9]" | sort -V -r > /tmp/versions.txt || echo "" > /tmp/versions.txt
        
        cat > _site/api/index.md << EOF
        ---
        layout: default
        title: Akka Cluster Public API Documentation
        ---
        
        # Akka Cluster Public API Documentation
        
        **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ## 📚 API Versions
        
        EOF
        
        if [ -s /tmp/versions.txt ]; then
          while read version; do
            if [ -f "_site/api/$version/index.md" ]; then
              echo "- [${version}](./${version}/) - Major version ${version#v}" >> _site/api/index.md
            fi
          done < /tmp/versions.txt
        else
          echo "- [v${{ steps.version.outputs.major_version }}](./v${{ steps.version.outputs.major_version }}/) - Major version ${{ steps.version.outputs.major_version }}" >> _site/api/index.md
        fi
        
        cat >> _site/api/index.md << EOF
        
        ## 🎯 What's in the Public API
        
        - **Message Protocol**: Actor messages (\`Ping\`, \`Pong\`) and service discovery keys
        - **Deployment Interface**: Docker Compose service definitions, ports, and networking
        
        ## 📖 Documentation Types
        
        - **Scala API**: Generated from source code comments (Scaladoc)
        - **Deployment API**: Extracted from Docker Compose configuration
        
        ## 🔄 Versioning Strategy
        
        - **Each major version** gets its own documentation
        - **Breaking changes** increment the major version
        - **Historical versions** remain available for migration reference
        
        ## 🚀 Getting Started
        
        1. **Choose the latest version** for new projects
        2. **Review breaking changes** when upgrading between major versions  
        3. **Follow the migration guides** in the GitHub releases
        
        ---
        
        Generated automatically from [brunoesposito2/DockerSwarmAkka](https://github.com/brunoesposito2/DockerSwarmAkka) releases.
        EOF

    - name: Create main site index
      run: |
        cat > _site/index.md << EOF
        ---
        layout: default
        title: Akka Cluster Docker Swarm Project
        ---
        
        # Akka Cluster Docker Swarm Project
        
        ## 📚 Message Protocol API
        
        **Scala API Documentation** - Actor message protocols and service keys  
        [Browse Scaladoc](./api/v${{ steps.version.outputs.major_version }}/index.html)
        
        ## 🐳 Deployment API  
        
        **Docker Compose Interface** - Service configuration and networking  
        [View Configuration](./api/v${{ steps.version.outputs.major_version }}/docker/deployment-api.html)
        
        ## Quick Start
        
        Deploy the cluster with Docker Compose:
        
        \`\`\`bash
        git clone https://github.com/brunoesposito2/DockerSwarmAkka.git
        cd DockerSwarmAkka
        docker-compose up -d
        \`\`\`
        
        ## API Versions
        
        > Browse all available API versions and migration guides.
        > 
        > When upgrading between major versions, review breaking changes carefully.
        
        - [All API Versions](./api/index.html) - Historical documentation
        - [Current Version v${{ steps.version.outputs.major_version }}](./api/v${{ steps.version.outputs.major_version }}/) - Latest API docs
        
        ## Project Structure
        
        This project demonstrates:
        - **Akka Actor Model** implementation with clustering
        - **Docker Swarm** orchestration and deployment
        - **Semantic Versioning** for API stability
        - **Automated Documentation** generation
        EOF

    # Aggiungi _config.yml se non esiste
    - name: Create Jekyll config if needed
      run: |
        if [ ! -f "_site/_config.yml" ]; then
          cat > _site/_config.yml << EOF
        title: "Akka Cluster Docker Swarm - API Documentation"
        description: "Public API documentation for Akka cluster deployment with Docker Swarm"
        url: "https://brunoesposito2.github.io"
        baseurl: "/DockerSwarmAkka"
        
        markdown: kramdown
        highlighter: rouge
        remote_theme: pages-themes/architect@v0.2.0
        
        plugins:
          - jekyll-seo-tag
          - jekyll-remote-theme
        
        show_downloads: false
        EOF
        fi

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_site/

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
        
    - name: Summary
      run: |
        echo "## 📖 API Documentation Generated Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Major Version:** v${{ steps.version.outputs.major_version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📁 Generated Documentation" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Scala API Documentation (Public packages only)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Docker Compose API Documentation" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Version-specific index page" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Main API index updated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔗 Links" >> $GITHUB_STEP_SUMMARY
        echo "- [View API Documentation](https://brunoesposito2.github.io/DockerSwarmAkka/)" >> $GITHUB_STEP_SUMMARY
        echo "- [Version v${{ steps.version.outputs.major_version }} Docs](https://brunoesposito2.github.io/DockerSwarmAkka/api/v${{ steps.version.outputs.major_version }}/)" >> $GITHUB_STEP_SUMMARY